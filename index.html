<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>ICNote - A Site for Sharing Notes about IC</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="himingway" />
  <meta name="description" content="A Site for Sharing Notes about IC" />
  <meta name="keywords" content="IC, note, cpu, digit" />






<meta name="generator" content="Hugo 0.58.1" />


<link rel="canonical" href="https://himingway.github.io/" />
<link href="%7balternate%20%7bRSS%20application/rss&#43;xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20https://himingway.github.io/index.xml%7d" rel="alternate" type="application/rss+xml" title="ICNote - A Site for Sharing Notes about IC" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.beeee9263145d19f5cdcf49ac6db6043d65e81a3baca2d98bf7dc637c4875a84.css" integrity="sha256-vu7pJjFF0Z9c3PSaxttgQ9ZegaO6yi2Yv33GN8SHWoQ=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/">


<meta property="og:title" content="ICNote - A Site for Sharing Notes about IC" />
<meta property="og:description" content="A Site for Sharing Notes about IC" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://himingway.github.io/" />

<meta property="og:updated_time" content="2019-09-12T21:47:15+08:00" />
<meta itemprop="name" content="ICNote - A Site for Sharing Notes about IC">
<meta itemprop="description" content="A Site for Sharing Notes about IC">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ICNote - A Site for Sharing Notes about IC"/>
<meta name="twitter:description" content="A Site for Sharing Notes about IC"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ICNote</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      ICNote
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item active">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://himingway.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          
<section id="posts" class="posts">
  
  
    
  
  
  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/pci-fundamental-and-pci-transaction-ordering/pci-configuration/">PCI Configuration</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-12" class="post-time">
        2019-09-12
      </time>
      <div class="post-category">
          <a href="https://himingway.github.io/categories/pci/"> PCI </a>
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      

<h2 id="1-pci-configuration-过程">1. PCI Configuration 过程</h2>

<p>例如，对 Bus Number 为 2，Device Number 为 1，Function Number 为 0 的 PCI 设备的第 3 个寄存器进行配置，具体步骤如下：</p>

<p><strong>Step1:</strong>  向 CONFIG_ADDRESS (CF8h) 地址（如图 3-2 所示）采用 I/O 写的方式写入 <code>32'b1_0000000_0000_0010_00001_000_000011_00</code></p>

<p><img src="/assets/20190912213318.png" alt="" /></p>

<p>如果设备直接挂在主桥上，主桥将会产生 Type 0 Configuration Transaction；如果设备没有挂在主桥上，将会产生 Type 1 Configuration Transaction 向下传输，当 Type 1 Configuration Transaction 到达设备所在的 Bridge 时，Type 1 Transaction 在 bridge 中将会转换为 Type 0 Transaction （如图 3-3 所示）。</p>

<p><img src="/assets/20190912213346.png" alt="" /></p>

<p>Bridge 的 AD[31:11] 连接 PCI 设备的 IDSEL 位，根据 Device Number 的数据，PCI Bridge 将将某个设备的 IDSEL 置为有效，便于下个 transaction 进行寄存器配置。</p>

<p><strong>Step2:</strong> 向 CONFIG_DATA (CFCh) 地址采用 I/O 写的方式向 Step1 中所选的 PCI 设备寄存器写入配置内容。</p>

<h3 id="1-1-example">1.1. Example</h3>

<h4 id="1-1-1-config-bus-1-device-2-function-3-reg-byte-47-data-0xff">1.1.1. Config bus 1, device 2, function 3, reg byte 47, data 0xff</h4>

<ul>
<li>CONFIG_ADDRESS (CF8h) Transaction：

<ul>
<li>ADDRESS 周期：ADDRESS 为 <code>32'hCF8</code>，Command 为 <code>4'b0011</code>（I/O 写）;</li>
<li>DATA 周期：DATA 为 <code>32'b1_0000000_00000001_00010_011_001011_00</code>；ByteEnable为 <code>4'b0000</code>，表明四个 Byte 都有效。</li>
</ul></li>
</ul>

<p><aa></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">   En_..Resv._..Bus..._.Dev._Fun_.Reg.._00
32&#39;b1_0000000_00000001_00010_011_001011_00
    1_...0..._...1...._..2.._.3._..11.._00</pre></td></tr></table>
</div>
</div>
<p></aa></p>

<ul>
<li>CONFIG_DATA (CFCh) Transaction<br />
由于第 Byte 47 寄存器相对于 Byte 44 寄存器偏移为 3 Byte，所以 CONFIG_DATA 的起始地址为 <code>CFCh + 3h = CFFh</code>。

<ul>
<li>ADDRESS 周期：ADDRESS 为 <code>32'hCFF</code>，Command 为 <code>4'b0011</code>（I/O 写）;</li>
<li>DATA 周期：ByteEnable 为 <code>4'b0111</code>，表明只有第四个 Byte 有效。DATA 为 <code>32'hFFxx_xxxx</code>，x 为 don&rsquo;t care，即向 Byte 44 寄存器  写入<code>FFh</code>。</li>
</ul></li>
</ul>

<p><img src="/assets/20190912213255.png" alt="" /></p>

<h4 id="1-1-2-read-bus-2-device-1-function-4-register-byte-24">1.1.2. Read bus 2, device 1, function 4, register byte 24.</h4>

<ul>
<li>CONFIG_ADDRESS (CF8h) Transaction：

<ul>
<li>ADDRESS 周期：ADDRESS 为 <code>32'hCF8</code>，Command 为 <code>4'b0011</code>（I/O 写）;</li>
<li>DATA 周期：DATA 为 <code>32'b1_0000000_00000010_00001_100_000110_00</code>；ByteEnable 为 <code>4'b0000</code>，表明四个 Byte 都有效。</li>
</ul></li>
</ul>

<p><aa></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">   En_..Resv._..Bus..._.Dev._Fun_.Reg.._00
32&#39;b1_0000000_00000010_00001_100_000110_00
    1_...0..._...2...._..1.._.4._..6..._00</pre></td></tr></table>
</div>
</div>
<p></aa></p>

<p><img src="/assets/20190912213806.png" alt="" /></p>

<ul>
<li>CONFIG_DATA (CFCh) Transaction<br />
由于第 Byte 24 寄存器相对于 Byte 24 寄存器偏移为 0 Byte，所以 CONFIG_DATA 的起始地址为 <code>CFCh + 0h = CFCh</code>。

<ul>
<li>ADDRESS 周期：ADDRESS 为 <code>32'hCFC</code>，Command 为 <code>4'b0010</code>（I/O 读）;</li>
<li>DATA 周期：ByteEnable 为 <code>4'b1110</code>，表明只有第一个 Byte 有效。DATA 为 <code>32'hxxxx_xxDD</code>，x 为 don&rsquo;t care，D 为读出的数据。</li>
</ul></li>
</ul>

<p><img src="/assets/20190912213419.png" alt="" /></p>

<h2 id="2-pci-configuration-关于-byteenable-位应该如何">2. PCI Configuration 关于 ByteEnable 位应该如何？</h2>

<p>PCI Configuration 向 CONFIG_ADDRESS (CF8h) 地址分别写入配置设备信息和配置内容，采用 I/O 写的方式。协议要求 I/O 写入的内容必须是 Full DWORD，只有写入的数据是 Full DWORD 配置才能写入到这两个寄存器中，否者该写入将会被视为普通的 I/O transaction。因此，在 CONFIG_ADDRESS 的数据周期，Byte Enable 必须全部有效。如果 Byte Enable 有一个无效，则不能正常的产生 CONFIG_ADDRESS 的 Configuration Transaction。</p>

<blockquote>
<p>Anytime a host bridge sees a full DWORD I/O write from the host to CONFIG_ADDRESS, the bridge must latch the data into its CONFIG_ADDRESS register. On full DWORD I/O reads to CONFIG_ADDRESS, the bridge must return the data in CONFIG_ADDRESS. Any other types of accesses to this address (non-DWORD) have no effect on CONFIG_ADDRESS and are executed as normal I/O transactions on the PCI bus. Therefore, the only I/O Space consumed by this register is a DWORD at the given address. I/O devices that share the same address but use BYTE or WORD registers are not affected because their transactions will pass through the host bridge unchanged.</p>
</blockquote>

<p>而对于 CONFIG_DATA，只要 I/O 地址落在 CFCh~CFFh 中，就可以对寄存器进行配置。</p>

<blockquote>
<p>When a host bridge sees an I/O access that falls inside the DWORD beginning at CONFIG_DATA address, it checks the Enable bit and the Bus Number in the CONFIG_ADDRESS register. If the Enable bit is set and the Bus Number matches the bridge&rsquo;s Bus Number or any Bus Number behind the bridge, a configuration cycle translation must be done.</p>
</blockquote>

<h2 id="3-software">3. Software</h2>

<p>x86 的 CPU 只有内存和 I/O 两种空间，没有专用的配置空间，PCI 协议规定利用特定的 I/O 空间操作驱动 PCI 桥路转换成配置空间的操作。目前存在两种转换机制，即配置机制 1#和配置机制 2#。配置机制 2#在新的设计中将不再被采用，新的设计应使用配置机制 1#来产生配置空间的物理操作。这种机制使用了两个特定的 32 位 I/O 空间，即 CF8h 和 CFCh。这两个空间对应于 PCI 桥路的两个寄存器，当桥路看到 CPU 在局部总线对这两个 I/O 空间进行双字 操作时，就将该 I/O 操作转变为 PCI 总线的配置操作。寄存器 CF8h 用于产生配置空间的地址（CONFIG-ADDRESS），寄存器 CFCh 用于保存 配置空间的读写数据（CONFIG-DATA）。</p>

<p>配置地址端口（CF8H）的格式定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">bit31: 使能  决定是否允许访问配置空间：为“1”时表示可以访问；为“0”时表示不可以访问
bit24~bit30: 保留
bit16~bit23:PCI 总线号 从系统中的 256 条总线中选择一条，0--255
bit11~bit15:PCI 设备号 在一条给定的总线上选择 32 个设备中的一个。0--31
bit8~bit10:PCI 设备功能号 选择多功能设备中的某一个功能，有八种功能，0--7
bit2~bit7: 寄存器号 选择配置空间中的一个双字（32 位）
bit0~bit1:00  用来要求你只能按双字（4 字节）来读写配置空间寄存器。</pre></td></tr></table>
</div>
</div>
<p>访问设备的 pci 空间时，将要访问配置空间寄存器的总线号、设备号、功能号和寄存器号以一个双字的格式写到配置地址端口 (CF8H-CFBH)，接着执行配置数据端口 (CFCH) 的读和写，向配置数据口写数据即向配置空间写数据，从配置数据口读数据即从配置空间读数据。 以下是在 DOS 下使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#define PCI_ADDRESS_PORT 0x0CF8
</span><span class="cp">#define PCI_DATA_PORT 0x0CFC
</span><span class="cp"></span><span class="c1">//获取总线号、设备号、功能号和寄存器号组成的地址。
</span><span class="c1"></span><span class="n">u32</span> <span class="nf">GetCf8Value</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span><span class="n">u8</span> <span class="n">Register</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="mh">0x80000000</span><span class="o">|</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">Register</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">u8</span> <span class="nf">PciRead8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span><span class="n">u8</span> <span class="n">Register</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">Cf8Val</span> <span class="o">=</span> <span class="n">GetCf8Value</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">Register</span><span class="p">);</span>
    <span class="n">u8</span> <span class="n">Stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">Cf8Val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
    <span class="n">u8</span> <span class="n">D8</span><span class="p">;</span>
    <span class="n">Cf8Val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span> <span class="c1">//转换成 CF8 配置端口地址格式，最后 2bit 是 0
</span><span class="c1"></span>    <span class="n">outpd</span><span class="p">(</span><span class="n">PCI_ADDRESS_PORT</span><span class="p">,</span> <span class="n">Cf8Val</span><span class="p">);</span>
    <span class="n">D8</span> <span class="o">=</span> <span class="n">inp</span><span class="p">(</span><span class="n">PCI_DATA_PORT</span> <span class="o">+</span> <span class="n">Stride</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">D8</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">PciWrite16</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span><span class="n">u8</span> <span class="n">Register</span><span class="p">,</span> <span class="n">u16</span> <span class="n">Data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">Cf8Val</span> <span class="o">=</span> <span class="n">GetCf8Value</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">Register</span><span class="p">);</span>
    <span class="n">u8</span> <span class="n">Stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">Cf8Val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
    <span class="n">Cf8Val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
    <span class="n">outpd</span><span class="p">(</span><span class="n">PCI_ADDRESS_PORT</span><span class="p">,</span> <span class="n">Cf8Val</span><span class="p">);</span>
    <span class="n">outpw</span><span class="p">(</span><span class="n">PCI_DATA_PORT</span> <span class="o">+</span> <span class="n">Stride</span><span class="p">,</span> <span class="n">Data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>从某个端口输入一个字节 (_inp)、一个字 (_inpw) 或一个双字 (_inpd)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></pre></td>
<td class="lntd">
<pre class="chroma">nt _inp(
   unsigned short port
);
unsigned short _inpw(
   unsigned short port
);
unsigned long _inpd(
   unsigned short port
);</pre></td></tr></table>
</div>
</div>
<p>_outp、_outpw 和 _outpd 功能分别，对指定的输出端口写字节、字和一个双字。</p>

<p>在 linux 中读 pci 配置空间读写，可以直接调用内核 api. 等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">pci_read_config_byte()
pci_read_config_word()</pre></td></tr></table>
</div>
</div>
<p>另外，在区别 I/O 空间和内存空间的进程的 I/O 空间写入数据。</p>

<p>outb() I/O 上写入 8 位数据 ( 1 字节 )；</p>

<p>outw() I/O 上写入 16 位数据 ( 2 字节 )；</p>

<p>outl () I/O 上写入 32 位数据 ( 4 字节）；</p>

<p>inb 从 I/O 端口读取一个字节；</p>

<p>inw 从 I/O 端口读取一个字。</p>

<hr />

<ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/table-of-content/">本系列文章目录</a></li>
</ul>

    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/eda/">EDA 工具使用笔记</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-10" class="post-time">
        2019-09-10
      </time>
      <div class="post-category">
          <a href="https://himingway.github.io/categories/eda/"> EDA </a>
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      

<h2 id="1-vcs-与-verdi-联合使用">1. VCS 与 Verdi 联合使用</h2>

<p>在 VCS 编译的时候，要额外加上 <code>-debug_access+all -kdb -lca</code> 这个三个选项参数，这样就能在 VCS Compile 中看到 simv.daidir/kdb.elab++这个目录，这个目录就是 VCS 为 Verdi 产生的库，其实就是 VCS 帮 Verdi 生成了一个 Verdi 认识的中间文件，可支持单步调试功能。</p>

<p>如果有了<code>​simv.daidir/kdb.elab++</code>库文件， 可以用<code>Verdi -sv +v2k -elab simv.daidir/kdb -ssf xxx.fsdb</code> 命令打开 Verdi，或者直接<code>Verdi -sv +v2k -ssf xxx.fsdb</code>，或者增加一个选项，<code>-gui=verdi</code>，表示使用 verdi 这个工具进行单步调试。</p>

    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/pci-fundamental-and-pci-transaction-ordering/pci-note/">PCI Note</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-09" class="post-time">
        2019-09-09
      </time>
      <div class="post-category">
          <a href="https://himingway.github.io/categories/pci/"> PCI </a>
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      

<h2 id="1-关于-memory-write-and-invalidate">1. 关于 <code>Memory Write and Invalidate</code></h2>

<p>规范中的描述是
It allows a memory performance optimization by invalidating a &ldquo;dirty&rdquo; line in a write-back cache without requiring the actual write-back cycle thus shortening access time.</p>

<p>对一个新手来说理解这句话很难，天书嘛。就像我。其实非常简单，分 3 步慢慢理解。
PCI 总线地址映射到 cpu 存储地址（内存地址），我们对这片 cpu 存储地址执行读写，等于读写了 PCI 总线地址，等于读写了 PCI 设备。</p>

<p>当这片 cpu 存储器地址使用 write back 的 chche 策略时，就会出现有的 cache 跟实际的存储器不一致。cache 里的内容会比存储器里的更新，当然术语习惯称它们为“脏” &ndash; dirty。标记为 dirty 的 cache 会在合适的时机 write back 到存储器&ndash;这里是 PCI 设备。</p>

<p>如果对 PCI 设备一次写入一段较大的数据，大于 1 个 cache line，而这个 cache 恰恰又是 dirty 的，那么就可以直接把数据写入存储器，同时把相关 cache line 的 dirty 标记去掉，这个操作就是 Memory Write and Invalidate 事务。 Invalidate 的是 cache line 的 dirty 标记。</p>

<hr />

<ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/table-of-content/">本系列文章目录</a></li>
</ul>

    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/pci-fundamental-and-pci-transaction-ordering/pci-fundamental-and-pci-transaction-ordering-2/">PCI Fundamental and PCI Transaction Ordering (2)</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-09" class="post-time">
        2019-09-09
      </time>
      <div class="post-category">
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      

<h2 id="2-pci-protocol">2. PCI Protocol</h2>

<h3 id="2-1-bus-command">2.1. Bus Command</h3>

<p><img src="/assets/20190909234959.png" alt="" /></p>

<p>PCI 的 C/BE#信号复用命令与字节选通引脚。在地址周期的时候，C/BE[3:0]#信号表示 PCI 总线的命令；这些命令如下表所示。</p>

<table>
<thead>
<tr>
<th>C/BE[3:0]#</th>
<th>命令类型</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>0000</td>
<td>Interrupt Acknowledge</td>
<td>中断响应总线事务读取当前挂接在 PCI 总线上的中断控制器的中断向量号。目前大多数处理器系统的中断控制器都不挂接在 PCI 总线上，因此这种总线事务很少使用</td>
</tr>

<tr>
<td>0001</td>
<td>Special Cycle</td>
<td>HOST 主桥可以使用 Special Cycle 事务在 PCI 总线上进行信息广播</td>
</tr>

<tr>
<td>0010</td>
<td>I/O Read</td>
<td>HOST 主桥可以使用该总线事务对 PCI 设备的 LO 地址空间进行读操作。目前多数 PCI 设备都不支持 O 地址空间，而仅支持存储器地址空间，但是仍有部分 PCI 设备同时包含 LO 地址空间和存储器地址空间</td>
</tr>

<tr>
<td>0011</td>
<td>I/O Write</td>
<td>对 PCⅠ总线的 LO 地址空间进行写操作</td>
</tr>

<tr>
<td>0100</td>
<td>Reserved</td>
<td>Reserved</td>
</tr>

<tr>
<td>0101</td>
<td>Reserved</td>
<td>Reserved</td>
</tr>

<tr>
<td>0110</td>
<td>Memory Read</td>
<td>HOST 主桥可以使用该总线事务对 PCI 设备的存储器空间进行读操作。PCI 设备也可以使用该总线事务读取处理器的存储器空间</td>
</tr>

<tr>
<td>0111</td>
<td>Memory Write</td>
<td>HOST 主桥可以使用该总线事务对 PCI 设备的存储器空间进行写操作。PCI 设备也可以使用该总线事务向处理器的存储器空间进行写操作</td>
</tr>

<tr>
<td>1000</td>
<td>Reserved</td>
<td>Reserved</td>
</tr>

<tr>
<td>1001</td>
<td>Reserved</td>
<td>Reserved</td>
</tr>

<tr>
<td>1010</td>
<td>Configuration Read</td>
<td>HOST 主桥可以对 PCl 设备的配置空间进行读操作。</td>
</tr>

<tr>
<td>1001</td>
<td>Configuration Write</td>
<td>HOST 主桥可以对 PCl 设备的配置空间进行写操作。</td>
</tr>

<tr>
<td>1100</td>
<td>Memory Read Multiple</td>
<td>HOST 主桥可以使用该总线事务对 PCI 设备的存储器空间进行多行读操作</td>
</tr>

<tr>
<td>1001</td>
<td>Dual Address Cycle</td>
<td>PCI 总线支持 64 位地址，处理器或者其他 PCI 设备访问 64 位 PCI 总线地址时，必须使用双地址周期产生 64 位的 PCI 总线地址。PCI 设备使用 DMA 读写方式访问 64 位的存储器地址时，也可以使用该总线事务</td>
</tr>

<tr>
<td>1000</td>
<td>Memory Read Line</td>
<td>HOST 主桥可以使用该总线事务对 PCI 设备的存储器空间进行单行读操作</td>
</tr>

<tr>
<td>1001</td>
<td>Memory Write and Invalidate</td>
<td>存储器写并无效操作，与存储器写不同，PCI 设备可以使用该总线事务对主存储器空间进行写操作。该总线事务将数据写人主存储器的同时，将对应 Cache 行中的数据“使无效”</td>
</tr>
</tbody>
</table>

<h3 id="2-2-basic-transfer-control">2.2. Basic Transfer Control</h3>

<p><img src="/assets/20190910001455.png" alt="" /></p>

<p>下面介绍 PCI 基本的传输协议：</p>

<ul>
<li>当 FRAME# 和 IRDY# 同时无效的时候，PCI BUS 处于闲置（IDLE）状态。</li>
<li>FRANE#有效，表明数据开始传输：

<ul>
<li>当 FRAME# 信号有效的第一个时钟周期，PCI BUS 为地址周期（Address Phase）。</li>
<li>当 IRDY# 和 TRDY# 同时有效的时候，PCI BUS 为数据周期（Data Phase）。</li>
<li>当 IRDY# 或 TRDY# 的时候，PCI BUS 为等待周期（Wait Cycle）。</li>
<li>当所需要的数据准备好的时候，xRDY# 必须是有效的（对于写操作，当 Master 的数据准备好的时候，IRDY# 有效；对于读操作，当 Target 的数据准备好哒时候，TRDY# 有效）。</li>
</ul></li>
<li>当 FRAME# 无效，IRDY# 有效的时候，标志着最后一笔传输，这笔传输必须被传输完成（也就是说，发生最后一笔传输的时候，IRDY# 和 TRDY# 必须是有效的，若 TRDY# 无效，则等待 TRDY# 有效）。</li>
<li>当最后一笔传输完成后，FRAME# 和 IRDY# 同时无效。</li>
</ul>

<hr />

<ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/table-of-content/">本系列文章目录</a></li>
</ul>

    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/pci-fundamental-and-pci-transaction-ordering/pci-fundamental-and-pci-transaction-ordering-1/">PCI Fundamental and PCI Transaction Ordering (1)</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-08" class="post-time">
        2019-09-08
      </time>
      <div class="post-category">
          <a href="https://himingway.github.io/categories/pci/"> PCI </a>
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      

<h2 id="1-pci-pin-list">1. PCI Pin List</h2>

<p><img src="/assets/20190908182945.png" alt="" /></p>

<p>在 PICI 设备中，对于 target 设备，它的 PIN 最小的数目为 47 个；对于 Master 设备，它的 PIN 最小的数目为 49 个。除了这些基本的 PIN，PCI 设备还有一些扩展的 PIN，比如 64 位扩展 PIN：AD[63:32]，等。对于基本的 PIN，它的名称和功能如下：</p>

<ul>
<li>AD[31:0]: 复用的地址和数据总线</li>
<li>C/BE[3::0]: 总线命令（Bus Command）和 Byte 使能信号（Byte Enable），这也是一个复用的总线。当总线在地址周期时，它的功能为总线命令；当总线在数据周期时候，它的功能为 Byte 使能。</li>
<li>PAR: Parity，奇偶校验位</li>
<li>FRAME#: 周期帧（Cycle Frame）, 当 FRAME# 有效时，意味着总线传输开始；当 FRAME# 无效时，意味着该时钟的传输为最后一个数据传输，或者数据传输已经完成。</li>
<li>IRDY#: 标志 Initiator 的数据准备完成 Ready</li>
<li>TRDY#: 标志 Target 的数据准备完成 Ready</li>
</ul>

<p><img src="/assets/20190908184159.png" alt="" /></p>

<ul>
<li>STOP#: 当该信号有效时候，Target 设备向 Master 设备发送停止信号。</li>
<li>LOCK#: PCI 主设备可以使用该信号，原子操作将目标设备的某个存储器或者 I/O 资源锁定，以禁止其他 PCI 主设备访问此资源，直到锁定这个资源的主设备将其释放。PCI 总线使用 LOCK# 信号实现 LOCK 总线事务，只有 HOST 主桥、PCI 桥或者其他桥片可以使用 LOCK#信号。</li>
<li>IDSEL: 在 PCI 总线配置读写总线事务中，该信号用于选择 PCI 目标设备。</li>
<li>DEVSEL#: 该信号有效时，表示 PCI 总线的目标设备已经准备好，该信号有效表示目标设备已经完成了地址译码，也就是说，这个信号已经被选择。</li>
<li>REQ#: Master 的 Request 仲裁信号。</li>
<li>GNT#: Master 的 Grant 仲裁信号。</li>
<li>INTx#: 请求中断信号。</li>
</ul>

<hr />

<ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/table-of-content/">本系列文章目录</a></li>
</ul>

    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/post/pci-fundamental-and-pci-transaction-ordering/table-of-content/">Table of Content for PCI Fundamental and PCI Transaction Ordering</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2019-09-08" class="post-time">
        2019-09-08
      </time>
      <div class="post-category">
          <a href="https://himingway.github.io/categories/pci/"> PCI </a>
          
        </div>
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/pci-fundamental-and-pci-transaction-ordering-1/">PCI Fundamental and PCI Transaction Ordering (1)</a></li>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/pci-fundamental-and-pci-transaction-ordering-2/">PCI Fundamental and PCI Transaction Ordering (2)</a></li>
</ul>

<hr />

<p>其它：</p>

<ul>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/pci-note/">PCI笔记</a></li>
<li><a href="/post/pci-fundamental-and-pci-transaction-ordering/pci-configuration/">PCI Configuration</a></li>
</ul>

    </div>
    
  </div>
</article>

  
</section>






  
  
  

  
  

  
  

  
  

  
  





        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:badppg@qq.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/himingway" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://himingway.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        himingway
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  














  <script src="/js/"></script>


</body>
</html>
